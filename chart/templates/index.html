{% extends 'layout.html' %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0"><span id="symbol"></span> (<span id="broker">{{ broker.name }}</span>) </h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active">Chart</li>
              </ol>
            </div><!-- /.col -->
          </div><!-- /.row -->
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content-header -->
  
      <!-- Main content -->
      <div class="content">
        <div class="container-fluid">
            
          <div class="row">
            <div class="col-lg-9">
                <div class="row">

                <!-- /.col -->
                <div class="col-md-4 col-sm-6 col-12">
                    <div class="info-box bg-primary">
                        <span class="info-box-icon"><i class="fas fa-clock"></i></span>
        
                        <div class="info-box-content">
                        <span class="info-box-text"  style="font-size: 20px;">TIME FRAME</span>
                        <span class="info-box-number" id="timeframe" style="font-size: 26px;"></span>
        
                        
                        </div>
                        <!-- /.info-box-content -->
                    </div>
                    <!-- /.info-box -->
                    </div>
                    <!-- /.col -->
                    <div class="col-md-4 col-sm-6 col-12">
                      <div class="info-box bg-success">
                        <span class="info-box-icon"><i class="far fa-star"></i></span>
          
                        <div class="info-box-content">
                          <span class="info-box-text"  style="font-size: 20px;">ASK PRICE</span>
                          <span class="info-box-number" id="ask" style="font-size: 26px;"></span>
          
                       
                        </div>
                        <!-- /.info-box-content -->
                      </div>
                      <!-- /.info-box -->
                    </div>
         
                    <div class="col-md-4 col-sm-6 col-12">
                      <div class="info-box bg-info">
                        <span class="info-box-icon"><i class="fas fa-hand-holding-usd"></i></span>
          
                        <div class="info-box-content">
                          <span class="info-box-text" style="font-size: 20px;" >BID PRICE</span>
                          <span class="info-box-number" id="bid" style="font-size: 26px;"></span>
          
                        </div>
                        <!-- /.info-box-content -->
                      </div>
                      <!-- /.info-box -->
                    </div>
                    <!-- /.col -->
                  </div>
              <div class="card">
                <div class="card-body">
      
                    <div id="canndle_stick_chart"></div>
                    <div id="canndle_stick_chart_zoom"></div>
                    <div id="macd_chart"></div>
                   
                
                </div>
              </div>
  
            </div>
            <!-- /.col-md-6 -->
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-body">
                        <form action="getSymbolData" method="POST">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-lg-5">
                                    <div class="form-group"  >
                                        <select class="form-control" name="selectedSymbol">
                                            {% for symbol in symbols %}
                                                <option value="{{ symbol.id }}"
                                                {% if currentview.symbol_id  == symbol.id %}
                                                    selected
                                                {% endif %}
                                                >{{ symbol.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group"> 
                                        <select class="form-control" name="selectedTimeframe" >
                                            {% for timeframe in timeframes %}
                                                <option value="{{ timeframe.id }}"
                                                    {% if currentview.timeframe_id  == timeframe.id %}
                                                        selected
                                                    {% endif %}
                                                >{{ timeframe.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <input type="submit" class="btn btn-primary mr-1 w-100" value="Get">
                                </div>     
                            </div>
                        </form>
                    </div>
                </div>


                <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Order Buy Test Spec<span id="symbolname"></span></h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body p-0">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Parameter</th>
                            <th>Spec</th>
                            <th>Value</th>
                          </tr>
                        </thead>
                        <tbody>
                    
                            {% for spec in orderbuyentryspecobjects %}
                                <tr>
                                    <td>{{spec.name}}</td>
                                    <td id="td_orderbuy_spec_{{spec.parameter}}">{{spec.entry_value}}</td>
                                    <td id="td_orderbuy_reading_{{spec.parameter}}"></td>
                                </tr>
                            {% endfor %}
        
                        </tbody>
                      </table>
                    </div>
                    <!-- /.card-body -->
                  </div>


                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Order Sell Test Spec<span id="symbolname"></span></h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body p-0">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Parameter</th>
                            <th>Spec</th>
                            <th>Value</th>
                          </tr>
                        </thead>
                        <tbody>
                    
                            {% for spec in ordersellentryspecobjects %}
                                <tr>
                                    <td>{{spec.name}}</td>
                                    <td id="td_ordersell_spec_{{spec.parameter}}">{{spec.entry_value}}</td>
                                    <td id="td_ordersell_reading_{{spec.parameter}}"></td>
                                </tr>
                            {% endfor %}
        
                        </tbody>
                      </table>
                    </div>
                    <!-- /.card-body -->
                  </div>

                  <div class="card ">
                    <div class="card-header">
                      <h3 class="card-title">Recent Order <div class="icheck-success d-inline ml-2">
                        <input type="checkbox" id="checkboxSuccess1">
                        <label for="checkboxSuccess1">
                           <small>(Auto Close @3$)</small> 
                        </label>
                      </div></h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body p-0">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Position</th>
                            <th>Symbol</th>
                            <th>Lot</th>
                            <th>Profit</th>
                            <th>Close</th>
                          </tr>
                        </thead>
                        <tbody id="order_table"> 
                            {% for order in orders %}
                                <tr>
                                    <td >{{order.position}}</td>
                                    <td >{{order.symbol}}</td>
                                    <td >{{order.lot}}</td>
                                    <td >{{order.profit}}</td>
                                    <td><a type="button" data-lot="{{order.lot}}" data-symbol="{{order.symbol}}" data-type="{{order.type}}" data-position="{{order.position}}" class="btn btn-danger btn-sm mr-1 closeorder float-right"><i class="far fa-stop-circle"></i></a>
                                        
                                    </td>      
                                </tr>
                            {% endfor %}
        
                        </tbody>
                      </table>
                    </div>
                    <!-- /.card-body -->
                  </div>

                  <div class="card ">
                    <div class="card-header ">
                      <h3 class="card-title">Recent Entry <div class="icheck-success d-inline ml-2">
                        <input type="checkbox" id="checkboxSuccess2">
                        <label for="checkboxSuccess2">
                           <small>(Sort by Symbol)</small> 
                        </label>
                      </div></h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body p-0">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Symbol</th>
                            <th>TF</th>
                            <th>Type</th>
                            <th ><span class="float-right">Details</span> </th>
                          </tr>
                        </thead>
                        <tbody id= "report_table">                   
                            {% for searchreport in searchreports %}
                                <tr>
                                    <td class="getSymbol" >{{searchreport.symbolname}}</td>
                                    <td >{{searchreport.timeframename}}</td>
                                    <td >{{searchreport.order_type}}</td>
                                    <td ><div class="float-right"><a type="button" data-type="{{searchreport.order_type}}" data-symbol="{{searchreport.symbol_id}}" data-id="{{searchreport.id}}" class="btn btn-success btn-sm mr-1 openorder"><i class="fas fa-running"></i></a><a type="button" data-id="{{searchreport.id}}" data-timeframe="{{searchreport.timeframe_id}}" data-symbol="{{searchreport.symbol_id}}" class="btn btn-primary btn-sm moreinfo"><i class="fas fa-eye"></i></a></div> </td>
                                    
                                </tr>
                            {% endfor %}
        
                        </tbody>
                      </table>
                    </div>
                    <!-- /.card-body -->
                  </div>

                  <!-- <button type="button" id="sendLineNotify" class="btn btn-info">Test Line Notify</button> -->
        
            </div>
            <!-- /.col-md-6 -->
          </div>
          <!-- /.row -->+-
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content -->
      <script>

        $("input[data-bootstrap-switch]").each(function(){
            $(this).bootstrapSwitch('state', $(this).prop('checked'));
        })
        var slopeSpec = 0.00001;
        var canndleStickChart = echarts.init(document.getElementById('canndle_stick_chart'));  
        var macdChart = echarts.init(document.getElementById('macd_chart')); 
        var canndleStickChartZoom = echarts.init(document.getElementById('canndle_stick_chart_zoom')); 
        

        var entryspecs = JSON.parse('{{ entryspecs|escapejs }}');
        var responseData = JSON.parse("{{resData|escapejs}}"); 
        var data = []
        var axisData = [];
        var MacdArr = [];
        var AvgMacdArr = [];
        var SignalArr = [];
        var HistogramArr = [];
        var RSIArr = [];
        var RSIDelayArr = [];
        var CCIArr = [];
        var SSMA5Arr = [];
        var SSMA8Arr = [];
        var SSMA13Arr = [];
        var SSMA20Arr = [];
        var SSMA50Arr = [];
        var SSMA100Arr = [];
        var Smoth_SSMA5Arr = [];
        var Smoth_SSMA8Arr = [];
        var Smoth_SSMA13Arr = [];
        var Smoth_SSMA20Arr = [];
        var Smoth_SSMA50Arr = [];
        var dataMA5 = [];
        var dataMA10 = [];
        var dataMA20 = [];
        var dataMA50 = [];
        var dataMA100 = [];
        var dataMA200 = [];
        var MarkData = [];
        var askPrice = 0;
        var bidPrice = 0;
        var MacdCrossData  = [];
        var markMA100LineCord = [];
        var MarkMA100Slope  = [];
        var sma100Trend = [];
        var ssma3LineOrder = null;
        var markLineCordSsma5 = []
        var markLineCordSsma8 = []
        var markLineCordSsma13 = []
        var regressiveEqSmma5 = [];
        var regressiveEqSmma8 = [];
        var regressiveEqSmma13 = [];
        var ssma5STD = 0;
        var ssma8STD = 0;
        var ssma13STD = 0;
        var dataResult = null
        var sma100ArrowLevel = null
        var foundEntryPoint = false;
        var lineLenght = 10;
        var momenttumBar = false;
        var trendPattern = false;
        var sma100PresentLevel = null

        $( document ).ready(function () {   
             setInterval(function(){
                $.ajax({
                    type: 'GET',
                    url: "{% url 'getohlc' %}",
                    success: function (response){
                        createData(response);
                        let html_order_table = ''
                        let html_report_search_table = ''
                        let btncolor = 'btn-success'
                        response.orders.forEach(order => {
                            if(order.profit < 0) btncolor = 'btn-danger'
                            html_order_table += `<tr>
                                    <td >${order.position}</td>
                                    <td >${order.symbol}</td>
                                    <td >${order.lot}</td>
                                    <td >${order.profit.toFixed(2)}</td>
                                    <td><a type="button" data-lot="${order.lot}" data-symbol="${order.symbol}" data-type="${order.type}" data-position="${order.position}" class="btn ${btncolor} btn-sm mr-1 closeorder float-right"><i class="far fa-stop-circle"></i></a></td>      
                                </tr>`
                        });

                        JSON.parse(response.searchreports).forEach(searchreport => {
                            html_report_search_table += `<tr>
                                    <td class="getSymbol" >${searchreport.fields.symbolname}</td>
                                    <td >${searchreport.fields.timeframename}</td>
                                    <td >${searchreport.fields.order_type}</td>
                                    <td ><div class="float-right"><a type="button" data-type="${searchreport.fields.order_type}" data-symbol="${searchreport.fields.symbol}" data-id="${searchreport.pk}" class="btn btn-success btn-sm mr-1 openorder"><i class="fas fa-running"></i></a><a type="button" data-id="${searchreport.pk}" data-timeframe="${searchreport.fields.timeframe}" data-symbol="${searchreport.fields.symbol}" class="btn btn-primary btn-sm moreinfo"><i class="fas fa-eye"></i></a></div> </td>
                                    
                                </tr>`
                        });

                        $('#order_table').html(html_order_table);
                        $('#report_table').html(html_report_search_table);

                    },
                    error: function(response){
                        location.reload(true);
                    }
                })
             },60000)

            //  setInterval(function(){
            //     console.log('working')
            //  },2000)

        });

        function createData(response){
            _forexData = response.series;
            // console.log(_forexData)
            askPrice = Number(response.price['ask']);
            bidPrice = Number(response.price['bid']);
            $("#ask").html(askPrice.toFixed(3));
            $("#bid").html(bidPrice.toFixed(3));
            $("#timeframe").html(response.price['timeframe']);
            $("#symbol").html(response.symbol);
            data = getData(_forexData);
            // console.log(data)
            closedPrice = getClosedPrice(_forexData);
            lowPrice = getLowPrice(_forexData);
            highPrice = getHighPrice(_forexData);
            axisData = getDateLabel(_forexData); 
            EMA_SHORT = EMACalc(closedPrice,12);
            EMA_LONG = EMACalc(closedPrice,26);
            EMA5Arr = EMACalc(closedPrice,5);
            EMA20Arr = EMACalc(closedPrice,20);
            EMA50Arr = EMACalc(closedPrice,50);
            EMA200Arr = EMACalc(closedPrice,200);
            MACD = MACDCalc(EMA_LONG,EMA_SHORT,26,12);
            SSMA5Arr = SSMA_Calc(closedPrice,5);
            SSMA8Arr = SSMA_Calc(closedPrice,8);
            SSMA13Arr = SSMA_Calc(closedPrice,13);
            SSMA20Arr = SSMA_Calc(closedPrice,20);
            SSMA50Arr = SSMA_Calc(closedPrice,50);
            SSMA100Arr = SSMA_Calc(closedPrice,100);
            RSI = RS(closedPrice,14);

            Smoth_SSMA5 = SSMA_BARESMOTH(SSMA5Arr,3);
            Smoth_SSMA8 = SSMA_BARESMOTH(SSMA8Arr,3);
            Smoth_SSMA13 = SSMA_BARESMOTH(SSMA13Arr,3);
            Smoth_SSMA20 = SSMA_BARESMOTH(SSMA20Arr,3);
            Smoth_SSMA50 = SSMA_BARESMOTH(SSMA50Arr,3);

            SIGNAL = EMACalc(MACD,9);
            HISTOGRAM = HistogramCalc(SIGNAL,MACD,9);

            var nullForMACD = Array(closedPrice.length - MACD.length).fill(null);
            var nullForSIGNAL = Array(closedPrice.length - SIGNAL.length).fill(null);
            var nullForHISTOGRAM = Array(closedPrice.length - HISTOGRAM.length).fill(null);
            var nullSmoth_SSMA5 = Array(closedPrice.length - Smoth_SSMA5.length).fill(null);
            var nullSmoth_SSMA8 = Array(closedPrice.length - Smoth_SSMA8.length).fill(null);
            var nullSmoth_SSMA13 = Array(closedPrice.length - Smoth_SSMA13.length).fill(null);
            var nullSmoth_SSMA20 = Array(closedPrice.length - Smoth_SSMA20.length).fill(null);
            var nullSmoth_SSMA50 = Array(closedPrice.length - Smoth_SSMA50.length).fill(null);
            var nullSmoth_SSMA100 = Array(closedPrice.length - SSMA100Arr.length).fill(null);
            var nullRS = Array(closedPrice.length - RSI.length).fill(null);

            RSIArr = nullRS.concat(RSI); 

            dataMA200 = calculateMA(200, data);
            dataMA100 =  nullSmoth_SSMA100.concat(SSMA100Arr);  //calculateMA(100, data); 

            MacdArr = nullForMACD.concat(MACD); 
            SignalArr = nullForSIGNAL.concat(SIGNAL); 
            HistogramArr = nullForHISTOGRAM.concat(HISTOGRAM); 

            Smoth_SSMA5Arr = nullSmoth_SSMA5.concat(Smoth_SSMA5); 
            Smoth_SSMA8Arr = nullSmoth_SSMA8.concat(Smoth_SSMA8); 
            Smoth_SSMA13Arr = nullSmoth_SSMA13.concat(Smoth_SSMA13); 
            Smoth_SSMA20Arr = nullSmoth_SSMA20.concat(Smoth_SSMA20); 
            Smoth_SSMA50Arr = nullSmoth_SSMA8.concat(Smoth_SSMA50); 

            MacdCrossData = getMacdCross(MacdArr,SignalArr)
  
            ssma5STD = StandardDeviationCalc(Smoth_SSMA5Arr,5); 
            ssma8STD = StandardDeviationCalc(Smoth_SSMA8Arr,5);  
            ssma13STD = StandardDeviationCalc(Smoth_SSMA13Arr,5);

            let regressiveEq = genRegressionLine(dataMA100,lineLenght)
            markMA100LineCord = getCoord(regressiveEq,dataMA100.length-1-lineLenght,dataMA100.length-1,lineLenght)

            sma100Trend = isUpTrend(regressiveEq[0],data,dataMA100,lineLenght,slopeSpec)

            sma100ArrowLevel = {
                sma100_arrow_below : sma100ArrowBelow(data,dataMA100,lineLenght),
                sma100_arrow_above : sma100ArrowAbove(data,dataMA100,lineLenght),
            }

            sma100PresentLevel = {
                sma100_present_below : sma100PresentBelow(data,dataMA100),
                sma100_present_above : sma100PresentAbove(data,dataMA100),
            }
            
            momenttumBar = getMomenttumBar(data,sma100PresentLevel,3);
            trendPattern = getTrendPattern(data,sma100PresentLevel);

            regressiveEqSmma5 = genRegressionLine(Smoth_SSMA5Arr,5)
            markLineCordSsma5 = getCoord(regressiveEqSmma5,Smoth_SSMA5Arr.length-1-5,Smoth_SSMA5Arr.length-1,5)

            regressiveEqSmma8 = genRegressionLine(Smoth_SSMA8Arr,5)
            markLineCordSsma8 = getCoord(regressiveEqSmma8,Smoth_SSMA8Arr.length-1-5,Smoth_SSMA8Arr.length-1,5)

            regressiveEqSmma13 = genRegressionLine(Smoth_SSMA13Arr,5)
            markLineCordSsma13 = getCoord(regressiveEqSmma13,Smoth_SSMA13Arr.length-1-5,Smoth_SSMA13Arr.length-1,5)

            
            // MarkMA100Slope = sma100Trend[0];

            ssma3LineOrder = getSsma3LineOrder(Smoth_SSMA5Arr,Smoth_SSMA8Arr,Smoth_SSMA13Arr)

            dataResult = createResult()
   
            // setDom(dataResult, entryspecs,1)
            setDom(dataResult, entryspecs.filter(x => x.fields.order_type == 0),entryspecs.filter(x => x.fields.order_type == 1),1)
         
           
            // if(foundEntryPoint === false){     
            //     findEntryPoint(dataResult, JSON.parse('{{ buytestspec|escapejs }}'))
            // }else{
            //     findExitPoint(dataResult, JSON.parse('{{ buytestspec|escapejs }}'));
            // }
              
            canndleStickChart.setOption({
                series : [
                    {
                        name: 'OHLC',
                        data: data,
                        markPoint: {
                            label: {
                                normal: {
                                    formatter: function (param) {
                                        return param != null ? param.data['name'] : '';
                                    }
                                }
                            },
                            data: MarkData,
                        },
                        markLine : {
                            data: [
                                [{
                                    coord: markLineCordSsma5[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }, {
                                    coord: markLineCordSsma5[1],
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma8[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }, {
                                    coord: markLineCordSsma8[1],
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma13[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }, {
                                    coord: markLineCordSsma13[1],
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }]
                            ],
                        },
                    }, 
                    {
                        name: 'SSMA20',
                        data: Smoth_SSMA20Arr,
                    },
                    {
                        name: 'SSMA5',
                        data: Smoth_SSMA5Arr,
                    }, 
                    {
                        name: 'SSMA8',
                        data: Smoth_SSMA8Arr,
                    }, 
                    {
                        name: 'SSMA13',
                        data: Smoth_SSMA13Arr,
                    }
                    // 
                ],                
                xAxis : [
                    {
                        data : axisData
                    }
                ],
                dataZoom : {
                    start : Math.round((data.length-90)/(data.length)*100),
                    end : 100
                },
            });

            macdChart.setOption({
                series : [
                    {
                        name:'MACD',
                        data: MacdArr,
                    },{
                        name:'SIGNAL',
                        data: SignalArr,
                    },{
                        name:'HISTOGRAM',
                        data: HistogramArr,
                    }
                ],                
                xAxis : [
                    {
                        data : axisData
                    }
                ],
                dataZoom : {
                    start : Math.round((data.length-90)/(data.length)*100),
                    end : 100
                },
            });

            canndleStickChartZoom.setOption({
                series : [
                    {
                        name: 'OHLC-ZOOM',
                        data: data,
                        // markPoint: {
                        //     label: {
                        //         normal: {
                        //             formatter: function (param) {
                        //                 return param != null ? param.data['name']['slope'] : '';
                        //             }
                        //         }
                        //     },
                        //     symbol: 'circle',
                        //     symbolRotate: 0,
                        //     symbolSize: [1, 1],
                        //     itemStyle: {
                        //         color: 'black'
                        //     },
                        //     data: MarkMA100Slope,
                        // },
                        markLine : {
                            data: [
                                [{
                                    coord: markMA100LineCord[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: 'white'
                                    }
                                    }, {
                                    coord: markMA100LineCord[1],
                                    lineStyle: {
                                        color: 'white'
                                    }
                                }]
                            ],
                        },
                    }, 
                    {
                        name: 'MA100',
                        data: dataMA100,
                    }
                ],                
                xAxis : [
                    {
                        data : axisData
                    }
                ],
                dataZoom : {
                    start : Math.round((data.length-300)/(data.length)*100),
                    end : 100
                },

            });

 
            
            // function setDom(_reading,_rawSpec,_type){
            //     // console.log(_rawSpec)
            //     _rawSpec.forEach(spec => {
            //         // console.log(spec.fields.parameter)
            //         let reading = _reading.find(x => x.parameter === spec.fields.parameter)
            //         if(typeof reading !== 'undefined'){
            //             const dom = document.querySelector(`#td_reading_${spec.fields.parameter}`);
            //             if(_type == 1){ // entry point
            //                 if(isNaN(reading.reading) === true){
            //                     if(reading.reading === spec.fields.entry_value){
            //                         dom.innerHTML = `<span class="badge bg-success" >${reading.reading}</span>`
            //                     }else{
            //                         dom.innerHTML = `<span class="badge bg-danger" >${reading.reading}</span>`
            //                     }
                                
            //                 }else{ 
            //                     if(spec.fields.compare_reverse == 1){
            //                         if(reading.reading > spec.fields.entry_value){
            //                             dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
            //                         }else{
            //                             dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
            //                         }
            //                     }else{
            //                         if(reading.reading < spec.fields.entry_value){
            //                             dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
            //                         }else{
            //                             dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
            //                         }
            //                     }
            //                 }

            //             }

  

            //         }
            //     });
            // }

            function setDom(_reading,_orderbuy_rawSpec,_ordersell_rawSpec,_type){
                _orderbuy_rawSpec.filter(x => x.fields.order_type == 0).forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    
                    if(typeof reading !== 'undefined'){
                        const dom = document.querySelector(`#td_orderbuy_reading_${spec.fields.parameter}`);
                        if(_type == 1){ // entry point
                            if(isNaN(reading.reading) === true){
                                if(reading.reading === spec.fields.entry_value){
                                    dom.innerHTML = `<span class="badge bg-success" >${reading.reading}</span>`
                                }else{
                                    dom.innerHTML = `<span class="badge bg-danger" >${reading.reading}</span>`
                                }
                            }else{ 
                                if(spec.fields.compare_reverse == 1){
                                    if(reading.reading > spec.fields.entry_value){
                                        dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }else{
                                        dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }
                                }else{
                                    if(reading.reading < spec.fields.entry_value){
                                        dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }else{
                                        dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }
                                }
                            }
                        }
                    }
                });

                _ordersell_rawSpec.filter(x => x.fields.order_type == 1).forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    if(typeof reading !== 'undefined'){
                        const dom = document.querySelector(`#td_ordersell_reading_${spec.fields.parameter}`);
                        if(_type == 1){ // entry point
                            if(isNaN(reading.reading) === true){
                                if(reading.reading === spec.fields.entry_value){
                                    dom.innerHTML = `<span class="badge bg-success" >${reading.reading}</span>`
                                }else{
                                    dom.innerHTML = `<span class="badge bg-danger" >${reading.reading}</span>`
                                }
                            }
                            else{ 
                                if(spec.fields.compare_reverse == 1){
                                    
                                    if(reading.reading > spec.fields.entry_value){
                                        dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }else{
                                        dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }
                                }else{
                                    if(spec.fields.entry_value < 0){
                                        if(reading.reading*-1 > spec.fields.entry_value*-1){
                                            dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }else{
                                            dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }
                                    }else{
                                        if(reading.reading < spec.fields.entry_value){
                                            dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }else{
                                            dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }
                                    }

                                }
                            }
                        }
                    }
                });

            }
            



            function createResult(){
                let _latestSsma5 = Smoth_SSMA5Arr[Smoth_SSMA5Arr.length-1];
                let _latestSsma8 = Smoth_SSMA8Arr[Smoth_SSMA8Arr.length-1];
                let _latestSsma13 = Smoth_SSMA13Arr[Smoth_SSMA13Arr.length-1];

                let sumssmaTrend = markLineCordSsma5[0][1] + markLineCordSsma8[0][1] + markLineCordSsma13[0][1] - markLineCordSsma5[1][1] - markLineCordSsma8[1][1] - markLineCordSsma13[1][1]
          
                let ssma8PercentDiffssma5 = Math.abs((_latestSsma8 - _latestSsma5)*100/_latestSsma8);
                let ssma8PercentDiffssma13 = Math.abs((_latestSsma8 - _latestSsma13)*100/_latestSsma8);

                // _result = {
                //     macd_value : MacdCrossData[3],
                //     macd_trend : (MacdCrossData[0]) ? 'up' : 'down',
                //     macd_cross : (MacdCrossData[1]) ? 'above' : 'below',
                //     ma100_slope : regressiveEq[0].toFixed(10),
                //     ma5_slope : regressiveEqSmma5[0].toFixed(10),
                //     ma5_value : _latestSsma5.toFixed(10),
                //     ma5_std : ssma5STD.toFixed(10),
                //     ma8_slope : regressiveEqSmma8[0].toFixed(10),
                //     ma8_value : _latestSsma8.toFixed(10),
                //     ma8_std : ssma8STD.toFixed(10),
                //     ma13_slope : regressiveEqSmma13[0].toFixed(10),
                //     ma13_value : _latestSsma13.toFixed(10),
                //     ma13_std : ssma13STD.toFixed(10),
                //     aligator_trend : (sumssmaTrend < 0) ? 'up' : 'down',
                //     rsi : RSIArr[RSIArr.length-1],
                //     ssma8_percent_diff_ssma5 : ssma8PercentDiffssma5,
                //     ssma8_percent_diff_ssma13 : ssma8PercentDiffssma13,
                //     sma_arrow : sma100ArrowLevel,
                //     ssma3line_order : ssma3LineOrder,
                // }
                // return _result;

                return [
                    {
                        parameter: 'macd_value',
                        reading: MacdCrossData[3]
                    },
                    {
                        parameter: 'macd_trend',
                        reading: (MacdCrossData[0]) ? 'Up' : 'Down'
                    },
                    {
                        parameter: 'macd_cross',
                        reading: (MacdCrossData[1]) ? 'Above' : 'Below'
                    },
                    {
                        parameter: 'ma100_slope',
                        reading: regressiveEq[0].toFixed(10)
                    },
                    {
                        parameter: 'ma5_slope',
                        reading: regressiveEqSmma5[0].toFixed(10)
                    },
                    {
                        parameter: 'ma5_std',
                        reading: ssma5STD.toFixed(10)
                    },
                    {
                        parameter: 'ma8_slope',
                        reading: regressiveEqSmma8[0].toFixed(10)
                    },
                    {
                        parameter: 'ma8_std',
                        reading: ssma8STD.toFixed(10)
                    },
                    {
                        parameter: 'ma13_slope',
                        reading: regressiveEqSmma13[0].toFixed(10)
                    },
                    {
                        parameter: 'ma13_std',
                        reading: ssma13STD.toFixed(10)
                    },
                    {
                        parameter: 'aligator_trend',
                        reading: (sumssmaTrend < 0) ? 'Up' : 'Down'
                    },
                    {
                        parameter: 'rsi',
                        reading: RSIArr[RSIArr.length-1]
                    },
                    {
                        parameter: 'ssma8_percent_diff_ssma5',
                        reading: ssma8PercentDiffssma5
                    },
                    {
                        parameter: 'ssma8_percent_diff_ssma13',
                        reading: ssma8PercentDiffssma13
                    },
                    {
                        parameter: 'sma100_arrow_below',
                        reading: sma100ArrowLevel.sma100_arrow_below ? 'True' : 'False'
                    },
                    {
                        parameter: 'sma100_arrow_above',
                        reading: sma100ArrowLevel.sma100_arrow_above ?  'True' : 'False'
                    },
                    {
                        parameter: 'sma100_present_below',
                        reading: sma100PresentLevel.sma100_present_below ? 'True' : 'False'
                    },
                    {
                        parameter: 'sma100_present_above',
                        reading: sma100PresentLevel.sma100_present_above ?  'True' : 'False'
                    },
                    {
                        parameter: 'aligator_order_uptrend',
                        reading: ssma3LineOrder.aligator_order_uptrend ?  'True' : 'False'
                    },
                    {
                        parameter: 'aligator_order_downtrend',
                        reading: ssma3LineOrder.aligator_order_downtrend ?  'True' : 'False'
                    },
                ];
            }

     

        }

        option = {
            backgroundColor: '#21202D',
            title : {
                // text: 'OHLC',
                textStyle: {
                    color: '#fff'
                }
            },
            tooltip : {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                showDelay: 0,             // delay ms
                // formatter: function (params) {
                //     var res = params[0].name;
                //     res += '<br/>' + params[0].seriesName;
                //     res += '<br/>  Open : ' + params[0].value[1] + '  High : ' + params[0].value[4];
                //     res += '<br/>  Close : ' + params[0].value[2] + '  Low : ' + params[0].value[3];
                //     return res;
                // }
            },
            legend: {
                data:['OHLC','SSMA20', 'SSMA5','SSMA8','SSMA13'],
                selected:{'SSMA20':false},
                textStyle: {
                    color: '#fff'
                }
            },
            toolbox: {
                show : true,
                feature : {
                    // mark : {show: true},
                    // dataZoom : {show: true},
                    // magicType : {show: true, type: ['line', 'bar']},
                    // restore : {show: true},
                    saveAsImage : {
                        show: true,
                        title: 'Save As picture'
                    }
                }
            },            
            dataZoom : 
                {
                    show : true,
                    realtime: true,
                    start : Math.round((data.length-90)/(data.length)*100),
                    end : 100,
                    handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    textStyle: {
                        color: '#fff'
                    },
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                },
            grid: {
                left: 80,
                top: 40,
                right: 20,
                bottom: 85
            },
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : true,
                    axisTick: {onGap:false},
                    splitLine: {show:false},
                    data : axisData,
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    scale:true,
                    boundaryGap: [0.05, 0.05],
                    splitArea : {show : true},
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            series : [
                {
                    name:'OHLC',
                    type:'candlestick',
                    data: data,
                    markPoint: {
                        label: {
                            normal: {
                                formatter: function (param) {
                                    return param != null ? param.data['name'] : '';
                                }
                            }
                        },
                        data: MarkData,
                    },
                    markLine : {
                            data: [
                                [{
                                    coord: markLineCordSsma5[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }, {
                                    coord: markLineCordSsma5[1],
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma8[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }, {
                                    coord: markLineCordSsma8[1],
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma13[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }, {
                                    coord: markLineCordSsma13[1],
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }]
                            ],
                        },
                    itemStyle: {
                        color: upColor,
                        color0: downColor,
                        borderColor: null,
                        borderColor0: null
                    },
                }, 
                {
                    name: 'SSMA20',
                    type: 'line',
                    data: Smoth_SSMA20Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }, {
                    name: 'SSMA5',
                    type: 'line',
                    data: Smoth_SSMA5Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }, {
                    name: 'SSMA8',
                    type: 'line',
                    data: Smoth_SSMA8Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }, {
                    name: 'SSMA13',
                    type: 'line',
                    data: Smoth_SSMA13Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                },
            ]
        };

        option_macd = {
            backgroundColor: '#21202D',
            tooltip : {
                trigger: 'axis',
                showDelay: 0             // delay ms
            },
            legend: {
                // y : -30,
                data:['MACD','SIGNAL','HISTOGRAM'],
                textStyle: {
                    color: '#fff'
                }
            },

            grid: {
                x: 80,
                y: 20,
                x2: 20,
                y2: 60
            },
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : true,
                    axisTick: {onGap:false},
                    splitLine: {show:false},
                    data : axisData,
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    scale:true,
                    splitNumber: 3,
                    boundaryGap: [0.05, 0.05],
                    splitArea : {show : true},
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            series : [
                {
                    name:'MACD',
                    type:'line',
                    symbol: 'none',
                    data: MacdArr,
                },{
                    name:'SIGNAL',
                    type:'line',
                    symbol: 'none',
                    data: SignalArr,
                },{
                    name:'HISTOGRAM',
                    type:'bar',
                    symbol: 'none',
                    data: HistogramArr,
                }
            ]
        };

        option_zoom = {
            backgroundColor: '#21202D',
            title : {
                // text: 'USDJPY',
                textStyle: {
                    color: '#fff'
                }
            },
            tooltip : {
                trigger: 'axis',
                showDelay: 0,             // delay ms
                // formatter: function (params) {
                //     var res = params[0].name;
                //     res += '<br/>' + params[0].seriesName;
                //     res += '<br/>  Open : ' + params[0].value[1] + '  High : ' + params[0].value[4];
                //     res += '<br/>  Close : ' + params[0].value[2] + '  Low : ' + params[0].value[3];
                //     return res;
                // }
            },
            legend: {
                data:['OHLC-ZOOM','MA100'],
                textStyle: {
                    color: '#fff'
                }
            },
            toolbox: {
                show : true,
                feature : {
                    // mark : {show: true},
                    // dataZoom : {show: true},
                    // magicType : {show: true, type: ['line', 'bar']},
                    // restore : {show: true},
                    saveAsImage : {
                        show: true,
                        title: 'Save As picture'
                    }
                }
            },            
            dataZoom : {
                y: 250,
                show : false,
                realtime: true,
                start : Math.round((data.length-300)/(data.length)*100),
                end : 100
            },
            grid: {
                left: 80,
                top: 40,
                right: 20,
                bottom: 85
            },
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : true,
                    axisTick: {onGap:false},
                    splitLine: {show:false},
                    data : axisData,                        
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    scale:true,
                    boundaryGap: [0.05, 0.05],
                    splitArea : {show : true},
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            series : [
                {
                    name:'OHLC-ZOOM',
                    type:'candlestick',
                    data: data,
                    // markPoint: {
                    //     label: {
                    //         normal: {
                    //             formatter: function (param) {
                    //                 return param != null ? param.data['name']['slope'] : '';
                    //             }
                    //         }
                    //     },
                    //     symbol: 'circle',
                    //     symbolRotate: 0,
                    //     symbolSize: [1, 1],
                    //     itemStyle: {
                    //         color: 'black'
                    //     },
                    //     data: MarkMA100Slope,
                    // },
                    markLine : {
                        data: [
                            [{
                                coord: markMA100LineCord[0],
                                symbol : 'none',
                                lineStyle: {
                                    color: 'white'
                                }
                                }, {
                                coord: markMA100LineCord[1],
                                lineStyle: {
                                    color: 'white'
                                }
                            }]
                        ],
                    },
                    itemStyle: {
                        color: upColor,
                        color0: downColor,
                        borderColor: null,
                        borderColor0: null
                    },
                }, 
                {
                    name: 'MA100',
                    type: 'line',
                    data: dataMA100,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }
            ]
        };

        canndleStickChart.setOption(option);
        macdChart.setOption(option_macd);
        canndleStickChartZoom.setOption(option_zoom);
    
        echarts.connect([canndleStickChart,macdChart,canndleStickChartZoom]);
        createData(responseData);
        window.onresize = function () {
            canndleStickChart.resize();
            macdChart.resize();
            canndleStickChartZoom.resize();
        }

        // $(document).on('click','#sendLineNotify', function(){
        //     lineNotification('').then(data => {
        //         alert('done');
        //     }).catch(error => {})
        // })

        function lineNotification(message){   
           return new Promise((resolve, reject) => {
                data = {
                    message: message,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
               $.ajax({
                   type: 'POST',
                   url: "{% url 'lineNotification' %}",
                   dataType : "json",
                   data: data,
                   success: function(data) {
                       resolve(data)
                   },
                   error: function(error) {
                       reject(error)
                   },
               })
           })
       }

       $(document).on('click','.moreinfo', function(){
           symbolData($(this).data('symbol'),$(this).data('timeframe')).then(data => { //0=order on Buy 1=order on Sell
                window.location.href = window.location.href
            }).catch(error => {})
       })

       function symbolData(symbol,timeframe){   
           return new Promise((resolve, reject) => {
                data = {
                    symbol: symbol,
                    timeframe: timeframe,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
               $.ajax({
                   type: 'POST',
                   url: "{% url 'symboldata' %}",
                   dataType : "json",
                   data: data,
                   success: function(data) {
                       resolve(data)
                   },
                   error: function(error) {
                       reject(error)
                   },
               })
           })
       }

       $(document).on('click','.openorder', function(){
        let type = 'buy';
        let lotsize = 0.05;
        if($(this).data('type').includes("Sell") == true) type = 'sell'

        Swal.fire({
            title: 'Open Order?',
            text: "Confirm to open order",
            input: 'text',
            inputValue: lotsize,
            inputAttributes: {
                autocapitalize: 'off'
            },
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK'
            }).then((result) => {
                if (isNaN(result.value) === false) {
                    if (result.isConfirmed) {
                        openOrder($(this).data('symbol'),type,parseFloat(result.value)).then(data => { //0=order on Buy 1=order on Sell
                            let html_order_table = ''
                            let html_report_search_table = ''
                            let btncolor = 'btn-success'
                            
                            data.orders.forEach(order => {
                                if(order.profit < 0) btncolor = 'btn-danger'
                                html_order_table += `<tr>
                                        <td >${order.position}</td>
                                        <td >${order.symbol}</td>
                                        <td >${order.lot}</td>
                                        <td >${order.profit.toFixed(2)}</td>
                                        <td><a type="button" data-lot="${order.lot}" data-symbol="${order.symbol}" data-type="${order.type}" data-position="${order.position}" class="btn ${btncolor} btn-sm mr-1 closeorder float-right"><i class="far fa-stop-circle"></i></a></td>      
                                    </tr>`
                            });

                            JSON.parse(data.searchreports).forEach(searchreport => {
                                html_report_search_table += `<tr>
                                        <td class="getSymbol" >${searchreport.fields.symbolname}</td>
                                        <td >${searchreport.fields.timeframename}</td>
                                        <td >${searchreport.fields.order_type}</td>
                                        <td ><div class="float-right"><a type="button" data-type="${searchreport.fields.order_type}" data-symbol="${searchreport.fields.symbol}" data-id="${searchreport.pk}" class="btn btn-success btn-sm mr-1 openorder"><i class="fas fa-running"></i></a><a type="button" data-id="${searchreport.pk}" data-timeframe="${searchreport.fields.timeframe}" data-symbol="${searchreport.fields.symbol}" class="btn btn-primary btn-sm moreinfo"><i class="fas fa-eye"></i></a></div> </td>
                                        
                                    </tr>`
                            });

                            $('#order_table').html(html_order_table);
                            $('#report_table').html(html_report_search_table);

                            }).catch(error => {})
                    }
                }else{
                    Swal.fire({
                        icon: 'warning',
                        title: 'Error',
                        text: 'Lot size is not correct',
                    })
                }

            })
        })

        function openOrder(symbol,ordertype,lot){   
           return new Promise((resolve, reject) => {
                data = {
                    symbol: symbol,
                    ordertype: ordertype,
                    lot: lot,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
               $.ajax({
                   type: 'POST',
                   url: "{% url 'openorder' %}",
                   dataType : "json",
                   data: data,
                   success: function(data) {
                       resolve(data)
                   },
                   error: function(error) {
                       reject(error)
                   },
               })
           })
       }

       $(document).on('click','.closeorder', function(){
        Swal.fire({
                title: 'Close Order?',
                text: "Confirm to close order!",
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
                }).then((result) => {
                if (result.isConfirmed) {
                    manualCloseOrder($(this).data('symbol'),$(this).data('position'),$(this).data('type'),$(this).data('lot')).then(data => { //0=order on Buy 1=order on Sell
                    // window.location.href = window.location.href
                    let html_order_table = ''
                    let html_report_search_table = ''
                    let btncolor = 'btn-success'

                    data.orders.forEach(order => {
                        if(order.profit < 0) btncolor = 'btn-danger'
                        html_order_table += `<tr>
                                <td >${order.position}</td>
                                <td >${order.symbol}</td>
                                <td >${order.lot}</td>
                                <td >${order.profit.toFixed(2)}</td>
                                <td><a type="button" data-lot="${order.lot}" data-symbol="${order.symbol}" data-type="${order.type}" data-position="${order.position}" class="btn ${btncolor} btn-sm mr-1 closeorder float-right"><i class="far fa-stop-circle"></i></a></td>      
                            </tr>`
                    });

                    JSON.parse(data.searchreports).forEach(searchreport => {
                        html_report_search_table += `<tr>
                                <td class="getSymbol" >${searchreport.fields.symbolname}</td>
                                <td >${searchreport.fields.timeframename}</td>
                                <td >${searchreport.fields.order_type}</td>
                                <td ><div class="float-right"><a type="button" data-type="${searchreport.fields.order_type}" data-symbol="${searchreport.fields.symbol}" data-id="${searchreport.pk}" class="btn btn-success btn-sm mr-1 openorder"><i class="fas fa-running"></i></a><a type="button" data-id="${searchreport.pk}" data-timeframe="${searchreport.fields.timeframe}" data-symbol="${searchreport.fields.symbol}" class="btn btn-primary btn-sm moreinfo"><i class="fas fa-eye"></i></a></div> </td>
                                
                            </tr>`
                    });

                    $('#order_table').html(html_order_table);
                    $('#report_table').html(html_report_search_table);
                    }).catch(error => {})
                }
            })
 
        })

        function manualCloseOrder(symbol,position,type,lot){   
           return new Promise((resolve, reject) => {
                data = {
                    symbol: symbol,
                    position: position,
                    type: type,
                    lot: lot,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
               $.ajax({
                   type: 'POST',
                   url: "{% url 'manualcloseorder' %}",
                   dataType : "json",
                   data: data,
                   success: function(data) {
                       resolve(data)
                   },
                   error: function(error) {
                       reject(error)
                   },
               })
           })
       }



    </script>

{% endblock %} 
