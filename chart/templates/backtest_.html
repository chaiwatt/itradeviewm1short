{% extends 'layout.html' %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">BACK TESTING: <span id="symbol"></span> <span id="timeframe"></span></h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active">Backtest</li>
              </ol>
            </div><!-- /.col -->
          </div><!-- /.row -->
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content-header -->
  
      <!-- Main content -->
      <div class="content">
        <div class="container-fluid">
     
          <div class="row">
            <div class="col-lg-9">
              <div class="card">
                <div class="card-body">
      
                    <div id="canndle_stick_chart"></div>
                    <div id="canndle_stick_chart_zoom"></div>
                    <div id="macd_chart"></div>
                    
                
                </div>
              </div>
  
            </div>
            <!-- /.col-md-6 -->
            <div class="col-lg-3">
        
                <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Back Test setting</h3>
                    </div>
                        {% csrf_token %}
                      <div class="card-body">
                          <div class="row">
                              <div class="col-md-12">
                                <div class="form-group">
                                    <div class="form-group">
                                        <label>Symbol</label>
                                        <select class="form-control"  name="selectedSymbol" id="symbols" >
                                            {% for symbol in symbols %}
                                                <option value="{{ symbol.id }}"
                                                        {% if symbol.id  == backtest.symbol_id %}
                                                            selected
                                                        {% endif %}
                                                    >{{ symbol.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                  </div>
                              </div>

                              <div class="col-md-6">
                                <div class="form-group"> 
                                    <label for="backtesttimeframe">Time frame</label>
                                    <select class="form-control" name="selectedTimeframe" id="backtesttimeframe" >
                                        {% for timeframe in timeframes %}
                                            <option value="{{ timeframe.id }}"
                                                {% if backtest.timeframe_id  == timeframe.id %}
                                                    selected
                                                {% endif %}
                                            >{{ timeframe.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group"> 
                                    <label for="timeframe">Back test size</label>
                                    <select class="form-control" name="backtestSize" id="backtestSize" >
                                        {% for backtestsize in backtestsizes %}
                                            <option value="{{ backtestsize.id }}"
                                                {% if backtest.backtestsize_id  == backtestsize.id %}
                                                    selected
                                                {% endif %}
                                            >{{ backtestsize.size }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                    <label for="interval">Interval</label>
                                    <select class="form-control" name="interval" id="interval" >
                                        {% for backtestinterval in backtestintervals %}
                                            <option value="{{ backtestinterval.id }}"
                                                {% if backtest.interval_id  == backtestinterval.id %}
                                                    selected
                                                {% endif %}
                                            >{{ backtestinterval.interval }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group">
                                    <label for="interval">Test time (second)</label>
                                    <input type="text" class="form-control" id="interval" value="" readonly>
                                </div>
                              </div>
                          </div>
                      </div>
                      <!-- /.card-body -->
      
                      <div class="card-footer ">
                        <div class="form-group float-right">
                            
                            <button type="button" id="btnSaveSetting" class="btn btn-success mr-1">New Job</button>
                          
                        </div>                        
                      </div>
                    <!-- </form> -->
                  </div>

                  <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Testing Job </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group"> 
                                    <label for="selectedBacktestJob">Select Job</label>
                                    <select class="form-control" name="selectedBacktestJob" id="selectedBacktestJob" >
                                        <option value="">== select job ==</option>
                                        {% for backtestjob in backtestjobs %}
                                            <option value="{{ backtestjob.id }}" data-id="{{ backtestjob.symbol_id }}" data-name="{{ backtestjob.symbolname }}">{{ backtestjob.symbolname }} {{ backtestjob.timeframename }} {{ backtestjob.code }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group float-right">
                                    <button type="button" id="deleteallbacktest" class="btn btn-danger mr-1">Delete All</button>
                                    <button type="button" id="deletebacktest" class="btn btn-danger mr-1">Delete</button>
                                    <button type="button" id="jogtest" class="btn btn-primary mr-1">Jog Test</button>
                                    <button type="button" id="autotest" class="btn btn-primary ">Auto Test</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Order Buy Test Spec <span id="symbolname"></span></h3>
                    </div>
                    <div class="card-body p-0">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Parameter</th>
                            <th>Spec</th>
                            <th>Value</th>
                          </tr>
                        </thead>
                        <tbody  id="orderbuy_spec_table">   
    
                        </tbody>
                      </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Order Sell Test Spec </h3>
                    </div>
                    <div class="card-body p-0">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Parameter</th>
                            <th>Spec</th>
                            <th>Value</th>
                          </tr>
                        </thead>
                        <tbody  id="ordersell_spec_table">   
    
                        </tbody>
                      </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Report</h3>
                       
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <table class="table table-striped">
                                    <thead>
                                      <tr>
                                        <th>#</th>
                                        <th>Entry Bar</th>      
                                        <th>Exit Bar</th>                              
                                      </tr>
                                    </thead>
                                    <tbody id="report_table">
                                    
                                    </tbody>
                                  </table>
                                <div class="form-group float-right">
                                   
                                    <button type="button" id="zoomatoposition" class="btn btn-primary mr-1">Zoom Position</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Exit Point Test Spec</h3>
                    </div>
                    <div class="card-body p-0">
                      <table class="table table-sm">
                        <thead>
                          <tr>
                            <th>Parameter</th>
                            <th>Spec</th>
                            <th>Value</th>
                          </tr>
                        </thead>
                        <tbody id="exit_point_spec_table">   

                        </tbody>
                      </table>
                    </div>
                </div>
            </div>
            <!-- /.col-md-6 -->
          </div>
          <!-- /.row -->
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content -->
      <script>

        // //Initialize Select2 Elements
        $('.select2').select2();

        // //Initialize Select2 Elements
        $('.select2bs4').select2({
            theme: 'bootstrap4'
        })
        var backtestTimer;
        var backtestTimerInterval = 500;
        var testRange = 250;
        var count = 0;
        var _rawData = [];
        var slopeSpec = 0.00001;
        var canndleStickChart = echarts.init(document.getElementById('canndle_stick_chart'));  
        var macdChart = echarts.init(document.getElementById('macd_chart')); 
        var canndleStickChartZoom = echarts.init(document.getElementById('canndle_stick_chart_zoom')); 
        var searchType = JSON.parse("{{searchtype|escapejs}}")[0].fields; 
        var responseData = [] ; //JSON.parse("{{resData|escapejs}}"); 
        var orderbuy_entry_specs = [];// JSON.parse('{{ entryspecs|escapejs }}');
        var ordersale_entry_specs = [];

        var orderbuy_close_specs = [];//JSON.parse('{{ exitspecs|escapejs }}');
        var ordersell_close_specs = [];
        var data = []
        var axisData = [];
        var MacdArr = [];
        var AvgMacdArr = [];
        var SignalArr = [];
        var HistogramArr = [];
        var RSIArr = [];
        var RSIDelayArr = [];
        var CCIArr = [];
        var SSMA5Arr = [];
        var SSMA8Arr = [];
        var SSMA13Arr = [];
        var SSMA20Arr = [];
        var SSMA50Arr = [];
        var SSMA100Arr = [];
        var Smoth_SSMA5Arr = [];
        var Smoth_SSMA8Arr = [];
        var Smoth_SSMA13Arr = [];
        var Smoth_SSMA20Arr = [];
        var Smoth_SSMA50Arr = [];
        var dataMA5 = [];
        var dataMA10 = [];
        var dataMA20 = [];
        var dataMA50 = [];
        var dataMA100 = [];
        var dataMA200 = [];
        var MarkData = [];
        var MacdCrossData  = [];
        var markMA100LineCord = [];
        var MarkMA100Slope  = [];
        var sma100Trend = [];
        var ssma3LineOrder = null;
        var markLineCordSsma5 = []
        var markLineCordSsma8 = []
        var markLineCordSsma13 = []
        var regressiveEqSmma5 = [];
        var regressiveEqSmma8 = [];
        var regressiveEqSmma13 = [];
        var ssma5STD = 0;
        var ssma8STD = 0;
        var ssma13STD = 0;
        var dataResult = null
        var sma100ArrowLevel = null
        var sma100PresentLevel = null
        var foundOrderBuyEntryPoint = false;
        var foundOrderSellEntryPoint = false;
        var orderBuyEntryPointflag = false;
        var orderSellEntryPointflag = false;
        var testResult = [];
        var tmpDataIn = null;
        var lineLenght = 10;
        var momenttumBar = false;
        var trendPattern = false;
   
        $( document ).ready(function () {   
            //  setInterval(function(){
            //     $.ajax({
            //         type: 'GET',
            //         url: "{% url 'getohlc' %}",
            //         success: function (response){
            //             createData(response);
            //             console.log(response);
            //         },
            //         error: function(response){
            //             console.log("Error occured")
            //             location.reload(true);
            //         }
            //     })
            //  },20000)
        });

   
        function createData(response){
            _forexData = response;
        
            data = getData(_forexData);
            // console.log(data)
            closedPrice = getClosedPrice(_forexData);
            lowPrice = getLowPrice(_forexData);
            highPrice = getHighPrice(_forexData);
            axisData = getDateLabel(_forexData); 
            EMA_SHORT = EMACalc(closedPrice,12);
            EMA_LONG = EMACalc(closedPrice,26);
            EMA5Arr = EMACalc(closedPrice,5);
            EMA20Arr = EMACalc(closedPrice,20);
            EMA50Arr = EMACalc(closedPrice,50);
            EMA200Arr = EMACalc(closedPrice,200);
            MACD = MACDCalc(EMA_LONG,EMA_SHORT,26,12);
            SSMA5Arr = SSMA_Calc(closedPrice,5);
            SSMA8Arr = SSMA_Calc(closedPrice,8);
            SSMA13Arr = SSMA_Calc(closedPrice,13);
            SSMA20Arr = SSMA_Calc(closedPrice,20);
            SSMA50Arr = SSMA_Calc(closedPrice,50);
            SSMA100Arr = SSMA_Calc(closedPrice,100);
            RSI = RS(closedPrice,14);

            Smoth_SSMA5 = SSMA_BARESMOTH(SSMA5Arr,3);
            Smoth_SSMA8 = SSMA_BARESMOTH(SSMA8Arr,3);
            Smoth_SSMA13 = SSMA_BARESMOTH(SSMA13Arr,3);
            Smoth_SSMA20 = SSMA_BARESMOTH(SSMA20Arr,3);
            Smoth_SSMA50 = SSMA_BARESMOTH(SSMA50Arr,3);
            // Smoth_SSMA100 = SSMA_BARESMOTH(SSMA100Arr,3);

            SIGNAL = EMACalc(MACD,9);
            HISTOGRAM = HistogramCalc(SIGNAL,MACD,9);

            var nullForMACD = Array(closedPrice.length - MACD.length).fill(null);
            var nullForSIGNAL = Array(closedPrice.length - SIGNAL.length).fill(null);
            var nullForHISTOGRAM = Array(closedPrice.length - HISTOGRAM.length).fill(null);
            var nullSmoth_SSMA5 = Array(closedPrice.length - Smoth_SSMA5.length).fill(null);
            var nullSmoth_SSMA8 = Array(closedPrice.length - Smoth_SSMA8.length).fill(null);
            var nullSmoth_SSMA13 = Array(closedPrice.length - Smoth_SSMA13.length).fill(null);
            var nullSmoth_SSMA20 = Array(closedPrice.length - Smoth_SSMA20.length).fill(null);
            var nullSmoth_SSMA50 = Array(closedPrice.length - Smoth_SSMA50.length).fill(null);
            var nullSmoth_SSMA100 = Array(closedPrice.length - SSMA100Arr.length).fill(null);
            var nullRS = Array(closedPrice.length - RSI.length).fill(null);

            RSIArr = nullRS.concat(RSI); 

     

            MacdArr = nullForMACD.concat(MACD); 
            SignalArr = nullForSIGNAL.concat(SIGNAL); 
            HistogramArr = nullForHISTOGRAM.concat(HISTOGRAM); 

            Smoth_SSMA5Arr = nullSmoth_SSMA5.concat(Smoth_SSMA5); 
            Smoth_SSMA8Arr = nullSmoth_SSMA8.concat(Smoth_SSMA8); 
            Smoth_SSMA13Arr = nullSmoth_SSMA13.concat(Smoth_SSMA13); 
            Smoth_SSMA20Arr = nullSmoth_SSMA20.concat(Smoth_SSMA20); 
            Smoth_SSMA50Arr = nullSmoth_SSMA50.concat(Smoth_SSMA50); 

            dataMA200 = calculateMA(200, data);
            dataMA100 =  nullSmoth_SSMA100.concat(SSMA100Arr);  //calculateMA(100, data); 

            MacdCrossData = getMacdCross(MacdArr,SignalArr)
  
            ssma5STD = StandardDeviationCalc(Smoth_SSMA5Arr,5); 
            ssma8STD = StandardDeviationCalc(Smoth_SSMA8Arr,5);  
            ssma13STD = StandardDeviationCalc(Smoth_SSMA13Arr,5);

            let regressiveEq = genRegressionLine(dataMA100,lineLenght)
            markMA100LineCord = getCoord(regressiveEq,dataMA100.length-1-lineLenght,dataMA100.length-1,lineLenght)

            sma100Trend = isUpTrend(regressiveEq[0],data,dataMA100,lineLenght,slopeSpec)

            sma100ArrowLevel = {
                sma100_arrow_below : sma100ArrowBelow(data,dataMA100,lineLenght),
                sma100_arrow_above : sma100ArrowAbove(data,dataMA100,lineLenght),
            }

            sma100PresentLevel = {
                sma100_present_below : sma100PresentBelow(data,dataMA100),
                sma100_present_above : sma100PresentAbove(data,dataMA100),
            }

            momenttumBar = getMomenttumBar(data,sma100PresentLevel,3);// getMomenttum2Bar(data,3)
            trendPattern = getTrendPattern(data,sma100PresentLevel);
            // console.log(trendPattern)
            // if(momenttumBar.foundBar == true){
                
            //     if(momenttumBar.order == 'buy'){
            //         console.log('MB Buy')
            //     }else{
            //         console.log('MB Sale')
            //     }
            // }

            regressiveEqSmma5 = genRegressionLine(Smoth_SSMA5Arr,5)
            markLineCordSsma5 = getCoord(regressiveEqSmma5,Smoth_SSMA5Arr.length-1-5,Smoth_SSMA5Arr.length-1,5)

            regressiveEqSmma8 = genRegressionLine(Smoth_SSMA8Arr,5)
            markLineCordSsma8 = getCoord(regressiveEqSmma8,Smoth_SSMA8Arr.length-1-5,Smoth_SSMA8Arr.length-1,5)

            regressiveEqSmma13 = genRegressionLine(Smoth_SSMA13Arr,5)
            markLineCordSsma13 = getCoord(regressiveEqSmma13,Smoth_SSMA13Arr.length-1-5,Smoth_SSMA13Arr.length-1,5)

            ssma3LineOrder = getSsma3LineOrder(Smoth_SSMA5Arr,Smoth_SSMA8Arr,Smoth_SSMA13Arr)

            dataResult = createResult()
            
            
            setDom(dataResult, orderbuy_entry_specs,ordersell_entry_specs,1)

            if(searchType.trend == 1){ 
                if(foundOrderBuyEntryPoint === false){  
                    foundOrderBuyEntryPoint = findOrderBuyEntryPoint(dataResult, orderbuy_entry_specs)
                    }else{
                        if(orderBuyEntryPointflag == false){
                                console.log('save order buy intry point at data id: ' + data[data.length-1][4])
                                tmpDataIn = {
                                    'type': 'Orber buy (Trend)',
                                    'data_id': data[data.length-1][4]
                                };
                                orderBuyEntryPointflag =true;
                                
                        }
                        if(findOrderBuyExitPoint(dataResult, orderbuy_close_specs)) {
                                foundOrderBuyEntryPoint = false
                                orderBuyEntryPointflag =false;
                                testResult.push({
                                    'entry': tmpDataIn.data_id,
                                    'type' : tmpDataIn.type,
                                    'exit': data[data.length-1][4]
                                })
                                tmpDataIn = null;
                                console.log('save order buy exit point ' )
                        } 
                }

                if(foundOrderSellEntryPoint === false){  
                    foundOrderSellEntryPoint = findOrderSellEntryPoint(dataResult, ordersell_entry_specs)
                }else{
                
                if(orderSellEntryPointflag == false){
                        console.log('save order sell intry')
    
                        tmpDataIn = {
                            'type': 'Order sell (Trend)',
                            'data_id': data[data.length-1][4]
                        };
                      
                        orderSellEntryPointflag =true;
                   
                }
                
                if(findOrderSellExitPoint(dataResult, ordersell_close_specs)) {
                        foundOrderSellEntryPoint = false
                        orderSellEntryPointflag =false;
                        testResult.push({
                            'entry': tmpDataIn.data_id,
                            'type' : tmpDataIn.type,
                            'exit': data[data.length-1][4]
                        })
                        tmpDataIn = null;
                        console.log('save order sell exit point '  )
                } 
                }
            }

            if(searchType.pattern == 1){ // search pattern   
                if(momenttumBar.foundBar == true){
                    if(momenttumBar.type == 1){
                        testResult.push({
                            'entry': momenttumBar.id,
                            'type' : 'Order sell (Momentum)',
                            'exit': momenttumBar.id
                        })  
                        
                        console.log('found Order sell (Momentum)')
                        
                    }else if(momenttumBar.type == 2){
                        testResult.push({
                            'entry': momenttumBar.id,
                            'type' : 'Order buy (Momentum)',
                            'exit': momenttumBar.id
                        })  
                        
                      
                        console.log('found Order buy (Momentum)')
                    }
                }

                if(trendPattern.foundBar == true){
                    if(trendPattern.type == 1){
                        testResult.push({
                            'entry': trendPattern.id,
                            'type' : 'Order sell (Pattern down trend)',
                            'exit': trendPattern.id
                        })  
                       
                        console.log('found Order sell (Pattern down trend)')
                    }else if(trendPattern.type == 2){
                        testResult.push({
                            'entry': trendPattern.id,
                            'type' : 'Order buy (Pattern up trend)',
                            'exit': trendPattern.id
                        })  
                        // console.log(trendPattern.id)
                     
                        console.log('found Order buy (Pattern up trend)')
                    }
                }

            }   
         


            canndleStickChart.setOption({
                series : [
                    {
                        name: 'OHLC',
                        data: data,
                        markPoint: {
                            label: {
                                normal: {
                                    formatter: function (param) {
                                        return param != null ? param.data['name'] : '';
                                    }
                                }
                            },
                            data: MarkData,
                        },
                        markLine : {
                            data: [
                                [{
                                    coord: markLineCordSsma5[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }, {
                                    coord: markLineCordSsma5[1],
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma8[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }, {
                                    coord: markLineCordSsma8[1],
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma13[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }, {
                                    coord: markLineCordSsma13[1],
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }]
                            ],
                        },
                    }, 
                    {
                        name: 'SSMA20',
                        data: Smoth_SSMA20Arr,
                    },
                    {
                        name: 'SSMA5',
                        data: Smoth_SSMA5Arr,
                    }, 
                    {
                        name: 'SSMA8',
                        data: Smoth_SSMA8Arr,
                    }, 
                    {
                        name: 'SSMA13',
                        data: Smoth_SSMA13Arr,
                    }
                    // 
                ],                
                xAxis : [
                    {
                        data : axisData
                    }
                ],
                dataZoom : {
                    start : Math.round((data.length-90)/(data.length)*100),
                    end : 100
                },
            });

            macdChart.setOption({
                series : [
                    {
                        name:'MACD',
                        data: MacdArr,
                    },{
                        name:'SIGNAL',
                        data: SignalArr,
                    },{
                        name:'HISTOGRAM',
                        data: HistogramArr,
                    }
                ],                
                xAxis : [
                    {
                        data : axisData
                    }
                ],
                dataZoom : {
                    start : Math.round((data.length-90)/(data.length)*100),
                    end : 100
                },
            });

            canndleStickChartZoom.setOption({
                series : [
                    {
                        name: 'OHLC-ZOOM',
                        data: data,
                        markPoint: {
                            label: {
                                normal: {
                                    formatter: function (param) {
                                        return param != null ? param.data['name'] : '';
                                    }
                                }
                            },
                            data: MarkData,
                        },
                        markLine : {
                            data: [
                                [{
                                    coord: markMA100LineCord[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: 'white'
                                    }
                                    }, {
                                    coord: markMA100LineCord[1],
                                    lineStyle: {
                                        color: 'white'
                                    }
                                }]
                            ],
                        },
                    }, 
                    {
                        name: 'MA100',
                        data: dataMA100,
                    }
                ],                
                xAxis : [
                    {
                        data : axisData
                    }
                ],
                dataZoom : {
                    start : Math.round((data.length-300)/(data.length)*100),
                    end : 100
                },

            });


            function findOrderBuyEntryPoint(_reading,_orderbuy_rawSpec,_ordersell_rawSpec){
                let result = true;
                _orderbuy_rawSpec.forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    if(typeof reading !== 'undefined'){
                        if(isNaN(reading.reading) === true){
                            if(reading.reading !== spec.fields.entry_value){
                                result = false ;
                                return
                            }
                        }else{ 
                            if(spec.fields.compare_reverse == 1){
                                if(reading.reading < spec.fields.entry_value){
                                    result = false ;
                                    return
                                }
                            }else{
                                if(reading.reading > spec.fields.entry_value){
                                    result = false ;
                                    return
                                }
                            }
                        }
                    }
                });
                return result;
            }

            function findOrderSellEntryPoint(_reading,_ordersell_rawSpec){
                let result = true;
                _ordersell_rawSpec.forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    if(typeof reading !== 'undefined'){
                        if(isNaN(reading.reading) === true){
                            if(reading.reading !== spec.fields.entry_value){
                                result = false ;
                                return
                            }
                        }else{ 
                            if(spec.fields.compare_reverse == 1){
                                if(reading.reading < spec.fields.entry_value){
                                    result = false ;
                                    return
                                }
                            }else{
                                if(spec.fields.entry_value < 0){
                                    if(reading.reading*-1 < spec.fields.entry_value*-1){
                                        result = false ;
                                        return
                                    }
                                }else{
                                    if(reading.reading > spec.fields.entry_value){
                                        result = false ;
                                        return
                                    }
                                }
                                
                            }
                        }
                    }
                });
                
                return result;
            }

            function findOrderBuyExitPoint(_reading,_orderbuy_close_rawSpec){
                let result = true;
                _orderbuy_close_rawSpec.forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    if(typeof reading !== 'undefined'){
                        if(isNaN(reading.reading) === true){
                            if(reading.reading !== spec.fields.exit_value){
                                result = false ;
                                return
                            }
                        }else{ 
                            if(spec.fields.compare_reverse == 1){
                                if(reading.reading < spec.fields.exit_value){
                                    result = false ;
                                    return
                                }
                            }else{
                                if(reading.reading > spec.fields.exit_value){
                                    result = false ;
                                    return
                                }
                            }
                        }
                    }
                });
                return result;
            }

            function findOrderSellExitPoint(_reading,_ordersell_close_rawSpec){
                let result = true;
                _ordersell_close_rawSpec.forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    if(typeof reading !== 'undefined'){
                        if(isNaN(reading.reading) === true){
                            if(reading.reading !== spec.fields.exit_value){
                                result = false ;
                                return
                            }
                        }else{ 
                            if(spec.fields.compare_reverse == 1){
                                if(reading.reading < spec.fields.exit_value){
                                    result = false ;
                                    return
                                }
                            }else{

                                if(spec.fields.exit_value < 0){
                                    if(reading.reading*-1 > spec.fields.exit_value*-1){
                                        result = false ;
                                        return
                                    }
                                }else{
                                    if(reading.reading > spec.fields.exit_value){
                                        result = false ;
                                        return
                                    }
                                }
                            }
                        }
                    }
                });
                return result;
            }

            function setDom(_reading,_orderbuy_rawSpec,_ordersell_rawSpec,_type){
                _orderbuy_rawSpec.filter(x => x.fields.order_type == 0).forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    
                    if(typeof reading !== 'undefined'){
                        const dom = document.querySelector(`#td_orderbuy_reading_${spec.fields.parameter}`);
                        if(_type == 1){ // entry point
                            if(isNaN(reading.reading) === true){
                                if(reading.reading === spec.fields.entry_value){
                                    dom.innerHTML = `<span class="badge bg-success" >${reading.reading}</span>`
                                }else{
                                    dom.innerHTML = `<span class="badge bg-danger" >${reading.reading}</span>`
                                }
                            }else{ 
                                if(spec.fields.compare_reverse == 1){
                                    if(reading.reading > spec.fields.entry_value){
                                        dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }else{
                                        dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }
                                }else{
                                    if(reading.reading < spec.fields.entry_value){
                                        dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }else{
                                        dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }
                                }
                            }
                        }
                    }
                });

                _ordersell_rawSpec.filter(x => x.fields.order_type == 1).forEach(spec => {
                    let reading = _reading.find(x => x.parameter === spec.fields.parameter)
                    if(typeof reading !== 'undefined'){
                        const dom = document.querySelector(`#td_ordersell_reading_${spec.fields.parameter}`);
                        if(_type == 1){ // entry point
                            if(isNaN(reading.reading) === true){
                                if(reading.reading === spec.fields.entry_value){
                                    dom.innerHTML = `<span class="badge bg-success" >${reading.reading}</span>`
                                }else{
                                    dom.innerHTML = `<span class="badge bg-danger" >${reading.reading}</span>`
                                }
                            }
                            else{ 
                                if(spec.fields.compare_reverse == 1){
                                    
                                    if(reading.reading > spec.fields.entry_value){
                                        dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }else{
                                        dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                    }
                                }else{
                                    if(spec.fields.entry_value < 0){
                                        if(reading.reading*-1 > spec.fields.entry_value*-1){
                                            dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }else{
                                            dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }
                                    }else{
                                        if(reading.reading < spec.fields.entry_value){
                                            dom.innerHTML = `<span class="badge bg-success" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }else{
                                            dom.innerHTML = `<span class="badge bg-danger" >${parseFloat(reading.reading).toFixed(8)}</span>`
                                        }
                                    }

                                }
                            }
                        }
                    }
                });

            }
            

            function createResult(){
                let _latestSsma5 = Smoth_SSMA5Arr[Smoth_SSMA5Arr.length-1];
                let _latestSsma8 = Smoth_SSMA8Arr[Smoth_SSMA8Arr.length-1];
                let _latestSsma13 = Smoth_SSMA13Arr[Smoth_SSMA13Arr.length-1];

                let sumssmaTrend = markLineCordSsma5[0][1] + markLineCordSsma8[0][1] + markLineCordSsma13[0][1] - markLineCordSsma5[1][1] - markLineCordSsma8[1][1] - markLineCordSsma13[1][1]
          
                let ssma8PercentDiffssma5 = Math.abs((_latestSsma8 - _latestSsma5)*100/_latestSsma8);
                let ssma8PercentDiffssma13 = Math.abs((_latestSsma8 - _latestSsma13)*100/_latestSsma8);

                // _result = {
                //     macd_value : MacdCrossData[3],
                //     macd_trend : (MacdCrossData[0]) ? 'up' : 'down',
                //     macd_cross : (MacdCrossData[1]) ? 'above' : 'below',
                //     ma100_slope : regressiveEq[0].toFixed(10),
                //     ma5_slope : regressiveEqSmma5[0].toFixed(10),
                //     ma5_value : _latestSsma5.toFixed(10),
                //     ma5_std : ssma5STD.toFixed(10),
                //     ma8_slope : regressiveEqSmma8[0].toFixed(10),
                //     ma8_value : _latestSsma8.toFixed(10),
                //     ma8_std : ssma8STD.toFixed(10),
                //     ma13_slope : regressiveEqSmma13[0].toFixed(10),
                //     ma13_value : _latestSsma13.toFixed(10),
                //     ma13_std : ssma13STD.toFixed(10),
                //     aligator_trend : (sumssmaTrend < 0) ? 'up' : 'down',
                //     rsi : RSIArr[RSIArr.length-1],
                //     ssma8_percent_diff_ssma5 : ssma8PercentDiffssma5,
                //     ssma8_percent_diff_ssma13 : ssma8PercentDiffssma13,
                //     sma_arrow : sma100ArrowLevel,
                //     ssma3line_order : ssma3LineOrder,
                // }
                // return _result;

                return [
                    {
                        parameter: 'macd_value',
                        reading: MacdCrossData[3]
                    },
                    {
                        parameter: 'macd_trend',
                        reading: (MacdCrossData[0]) ? 'Up' : 'Down'
                    },
                    {
                        parameter: 'macd_cross',
                        reading: (MacdCrossData[1]) ? 'Above' : 'Below'
                    },
                    {
                        parameter: 'ma100_slope',
                        reading: regressiveEq[0].toFixed(10)
                    },
                    {
                        parameter: 'ma5_slope',
                        reading: regressiveEqSmma5[0].toFixed(10)
                    },
                    {
                        parameter: 'ma5_std',
                        reading: ssma5STD.toFixed(10)
                    },
                    {
                        parameter: 'ma8_slope',
                        reading: regressiveEqSmma8[0].toFixed(10)
                    },
                    {
                        parameter: 'ma8_std',
                        reading: ssma8STD.toFixed(10)
                    },
                    {
                        parameter: 'ma13_slope',
                        reading: regressiveEqSmma13[0].toFixed(10)
                    },
                    {
                        parameter: 'ma13_std',
                        reading: ssma13STD.toFixed(10)
                    },
                    {
                        parameter: 'aligator_trend',
                        reading: (sumssmaTrend < 0) ? 'Up' : 'Down'
                    },
                    {
                        parameter: 'rsi',
                        reading: RSIArr[RSIArr.length-1]
                    },
                    {
                        parameter: 'ssma8_percent_diff_ssma5',
                        reading: ssma8PercentDiffssma5
                    },
                    {
                        parameter: 'ssma8_percent_diff_ssma13',
                        reading: ssma8PercentDiffssma13
                    },
                    {
                        parameter: 'sma100_arrow_below',
                        reading: sma100ArrowLevel.sma100_arrow_below ? 'True' : 'False'
                    },
                    {
                        parameter: 'sma100_arrow_above',
                        reading: sma100ArrowLevel.sma100_arrow_above ?  'True' : 'False'
                    },

                    {
                        parameter: 'sma100_present_below',
                        reading: sma100PresentLevel.sma100_present_below ? 'True' : 'False'
                    },
                    {
                        parameter: 'sma100_present_above',
                        reading: sma100PresentLevel.sma100_present_above ?  'True' : 'False'
                    },

                    {
                        parameter: 'aligator_order_uptrend',
                        reading: ssma3LineOrder.aligator_order_uptrend ?  'True' : 'False'
                    },
                    {
                        parameter: 'aligator_order_downtrend',
                        reading: ssma3LineOrder.aligator_order_downtrend ?  'True' : 'False'
                    },
                ];
            }

     
        }

        option = {
            backgroundColor: '#21202D',
            title : {
                // text: 'OHLC',
                textStyle: {
                    color: '#fff'
                }
            },
            tooltip : {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                showDelay: 0,             // delay ms
                // formatter: function (params) {
                //     var res = params[0].name;
                //     res += '<br/>' + params[0].seriesName;
                //     res += '<br/>  Open : ' + params[0].value[1] + '  High : ' + params[0].value[4];
                //     res += '<br/>  Close : ' + params[0].value[2] + '  Low : ' + params[0].value[3];
                //     return res;
                // }
            },
            legend: {
                data:['OHLC','SSMA20', 'SSMA5','SSMA8','SSMA13'],
                selected:{'SSMA20':false},
                textStyle: {
                    color: '#fff'
                }
            },
            toolbox: {
                show : true,
                feature : {
                    // mark : {show: true},
                    // dataZoom : {show: true},
                    // magicType : {show: true, type: ['line', 'bar']},
                    // restore : {show: true},
                    saveAsImage : {
                        show: true,
                        title: 'Save As picture'
                    }
                }
            },            
            dataZoom : 
                {
                    show : true,
                    realtime: true,
                    start : Math.round((data.length-90)/(data.length)*100),
                    end : 100,
                    handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    textStyle: {
                        color: '#fff'
                    },
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                },
            grid: {
                left: 80,
                top: 40,
                right: 20,
                bottom: 85
            },
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : true,
                    axisTick: {onGap:false},
                    splitLine: {show:false},
                    data : axisData,
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    scale:true,
                    boundaryGap: [0.05, 0.05],
                    splitArea : {show : true},
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            series : [
                {
                    name:'OHLC',
                    type:'candlestick',
                    data: data,
                    markPoint: {
                        label: {
                            normal: {
                                formatter: function (param) {
                                    return param != null ? param.data['name'] : '';
                                }
                            }
                        },
                        data: MarkData,
                    },
                    markLine : {
                            data: [
                                [{
                                    coord: markLineCordSsma5[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }, {
                                    coord: markLineCordSsma5[1],
                                    lineStyle: {
                                        color: '#2f4554'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma8[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }, {
                                    coord: markLineCordSsma8[1],
                                    lineStyle: {
                                        color: '#61a0a8'
                                    }
                                }],
                                [{
                                    coord: markLineCordSsma13[0],
                                    symbol : 'none',
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }, {
                                    coord: markLineCordSsma13[1],
                                    lineStyle: {
                                        color: '#d48265'
                                    }
                                }]
                            ],
                        },
                    itemStyle: {
                        color: upColor,
                        color0: downColor,
                        borderColor: null,
                        borderColor0: null
                    },
                }, 
                {
                    name: 'SSMA20',
                    type: 'line',
                    data: Smoth_SSMA20Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }, {
                    name: 'SSMA5',
                    type: 'line',
                    data: Smoth_SSMA5Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }, {
                    name: 'SSMA8',
                    type: 'line',
                    data: Smoth_SSMA8Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }, {
                    name: 'SSMA13',
                    type: 'line',
                    data: Smoth_SSMA13Arr,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                },
            ]
        };

        option_macd = {
            backgroundColor: '#21202D',
            tooltip : {
                trigger: 'axis',
                showDelay: 0             // delay ms
            },
            legend: {
                // y : -30,
                data:['MACD','SIGNAL','HISTOGRAM'],
                textStyle: {
                    color: '#fff'
                }
            },

            grid: {
                x: 80,
                y: 20,
                x2: 20,
                y2: 60
            },
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : true,
                    axisTick: {onGap:false},
                    splitLine: {show:false},
                    data : axisData,
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    scale:true,
                    splitNumber: 3,
                    boundaryGap: [0.05, 0.05],
                    splitArea : {show : true},
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            series : [
                {
                    name:'MACD',
                    type:'line',
                    symbol: 'none',
                    data: MacdArr,
                },{
                    name:'SIGNAL',
                    type:'line',
                    symbol: 'none',
                    data: SignalArr,
                },{
                    name:'HISTOGRAM',
                    type:'bar',
                    symbol: 'none',
                    data: HistogramArr,
                }
            ]
        };

        option_zoom = {
            backgroundColor: '#21202D',
            title : {
                // text: 'USDJPY',
                textStyle: {
                    color: '#fff'
                }
            },
            tooltip : {
                trigger: 'axis',
                showDelay: 0,             // delay ms
                // formatter: function (params) {
                //     var res = params[0].name;
                //     res += '<br/>' + params[0].seriesName;
                //     res += '<br/>  Open : ' + params[0].value[1] + '  High : ' + params[0].value[4];
                //     res += '<br/>  Close : ' + params[0].value[2] + '  Low : ' + params[0].value[3];
                //     return res;
                // }
            },
            legend: {
                data:['OHLC-ZOOM','MA100'],
                textStyle: {
                    color: '#fff'
                }
            },
            toolbox: {
                show : true,
                feature : {
                    // mark : {show: true},
                    // dataZoom : {show: true},
                    // magicType : {show: true, type: ['line', 'bar']},
                    // restore : {show: true},
                    saveAsImage : {
                        show: true,
                        title: 'Save As picture'
                    }
                }
            },            
            dataZoom : {
                y: 250,
                show : false,
                realtime: true,
                start : Math.round((data.length-300)/(data.length)*100),
                end : 100
            },
            grid: {
                left: 80,
                top: 40,
                right: 20,
                bottom: 85
            },
            xAxis : [
                {
                    type : 'category',
                    boundaryGap : true,
                    axisTick: {onGap:false},
                    splitLine: {show:false},
                    data : axisData,                        
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    scale:true,
                    boundaryGap: [0.05, 0.05],
                    splitArea : {show : true},
                    axisLine:{
                        lineStyle:{
                            color:'#aca9a9'
                        }
                    },
                }
            ],
            series : [
                {
                    name:'OHLC-ZOOM',
                    type:'candlestick',
                    data: data,
                    // markPoint: {
                    //     label: {
                    //         normal: {
                    //             formatter: function (param) {
                    //                 return param != null ? param.data['name']['slope'] : '';
                    //             }
                    //         }
                    //     },
                    //     symbol: 'circle',
                    //     symbolRotate: 0,
                    //     symbolSize: [1, 1],
                    //     itemStyle: {
                    //         color: 'black'
                    //     },
                    //     data: MarkMA100Slope,
                    // },
                    markLine : {
                        data: [
                            [{
                                coord: markMA100LineCord[0],
                                symbol : 'none',
                                lineStyle: {
                                    color: 'white'
                                }
                                }, {
                                coord: markMA100LineCord[1],
                                lineStyle: {
                                    color: 'white'
                                }
                            }]
                        ],
                    },
                    itemStyle: {
                        color: upColor,
                        color0: downColor,
                        borderColor: null,
                        borderColor0: null
                    },
                }, 
                {
                    name: 'MA100',
                    type: 'line',
                    data: dataMA100,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1
                    }
                }
            ]
        };

        canndleStickChart.setOption(option);
        macdChart.setOption(option_macd);
        canndleStickChartZoom.setOption(option_zoom);
        
        echarts.connect([canndleStickChart,macdChart,canndleStickChartZoom]);

        if(responseData.length !== 0){
            createData(responseData);
            window.onresize = function () {
                canndleStickChart.resize();
                macdChart.resize();
                canndleStickChartZoom.resize();
            }
        }

        canndleStickChart.on('click', function(params) {
            console.log(params.data[1] - params.data[2])
            let openSubtractClose = params.data[1] - params.data[2]
            if(openSubtractClose > 0){
                console.log('bear')
                let wick = params.data[4] - params.data[1]
                let diffbodywick = 100-((Math.abs(openSubtractClose) - Math.abs(wick))*100/Math.abs(openSubtractClose))
                let tail = params.data[3] - params.data[2]
                let diffbodytail = 100-((Math.abs(openSubtractClose) - Math.abs(tail))*100/Math.abs(openSubtractClose))
                console.log(diffbodywick + ' ' + diffbodytail)
            }else{
                console.log('bull')
                let wick = params.data[4] - params.data[2]
                let diffbodywick = 100-((Math.abs(openSubtractClose) - Math.abs(wick))*100/Math.abs(openSubtractClose))
                let tail = params.data[3] - params.data[1]
                let diffbodytail = 100-((Math.abs(openSubtractClose) - Math.abs(tail))*100/Math.abs(openSubtractClose))
                console.log(diffbodywick + ' ' + diffbodytail)
            }
            console.log(Math.abs(params.data[1]-params.data[2]))
        });


        
        $(document).on('click','#zoomatoposition',function(){
            let firstIndex = _rawData[0].index;
            // console.log(firstIndex)
            testResult.forEach((result,key )=> {
                let entryindex = result.entry - firstIndex;
                let entryvalue = _rawData[entryindex]
                let exitindex = result.exit - firstIndex;
                let exitvalue = _rawData[exitindex]
                // console.log(entryvalue)
                MarkData.push({
                    name: "Entry",
                    value: entryvalue.close,
                    xAxis: entryindex,
                    yAxis: entryvalue.close,
                    color: "#fff",
                });
                MarkData.push({
                    name: "Exit",
                    value: exitvalue.close,
                    xAxis: exitindex,
                    yAxis: exitvalue.close,
                    color: "#fff",
                });
            })

            createData(_rawData);
            // console.log(_rawData)
            canndleStickChart.dispatchAction({
                type: 'dataZoom',
                start: 44,
                end: 60
            });
        })

        $(document).on("click","#btnSaveSetting",function() {
            Swal.fire({
                title: 'Create Job?',
                text: "Confirm to create new job!",
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
                }).then((result) => {
                if (result.isConfirmed) {
                    
                    addBackTestSetting($('#symbols').val(),$('#backtesttimeframe').val(),$('#backtestSize').val(),$('#interval').val()).then(data => {
                        Swal.fire({
                            //position: 'top-end',
                            icon: 'success',
                            html: `<h2>Job name <br><strong>${JSON.parse(data.backtest)[0].fields.symbolname} ${JSON.parse(data.backtest)[0].fields.timeframename} ${JSON.parse(data.backtest)[0].fields.code}</strong> <br>has been created<h2>`,
                            showConfirmButton: false,
                            timer: 2000
                        }).then(function (result) {
                            renderBacktestJobLists(data.backtestjobs)
                        })
                    }).catch(error => {})
                }
            })
        });

        function renderBacktestJobLists(jobs){
            let html = `<option value="">== select job ==</option>`;
            JSON.parse(jobs).forEach(job => {
                html += `<option value="${job.pk}"  data-id="${job.fields.symbol}" data-name="${job.fields.symbolname}">${job.fields.symbolname} ${job.fields.timeframename} ${job.fields.code}</option>`
            });
            $('#selectedBacktestJob').html(html);
        }

        function addBackTestSetting(symbol,timeframe,size,interval){
            return new Promise((resolve, reject) => {
                data = {
                    backtestsymbol: symbol,
                    timeframe: timeframe,
                    size: size,
                    interval: interval,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
                $.ajax({
                    type: 'POST',
                    url: "{% url 'createbacktest' %}",
                    dataType : "json",
                    data: data,
                    beforeSend: function(){
                        $('#loader').show();
                    },
                    success: function(data) {
                        resolve(data)
                    },
                    complete:function(data){
                        $('#loader').hide();
                    },
                    error: function(error) {
                        reject(error)
                    },
                })
            })
        }

        
        $(document).on("click","#deleteallbacktest",function() {
            resetCounter()
            if($('#selectedBacktestJob > option').length < 2) return
            Swal.fire({
                title: 'Delete All?',
                text: "Confirm to delete all jobs!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
                }).then((result) => {
                if (result.isConfirmed) {
                    deleteAllBacktest().then(data => {
                        Swal.fire({
                            //position: 'top-end',
                            icon: 'success',
                            title: 'All Jobs have been deleted',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(function (result) {
                            // renderBacktestJobLists(data.backtestjobs)
                            window.location.href = window.location.href
                        })
                    }).catch(error => {})
                }
            })

        })

        
        function deleteAllBacktest(){   
           return new Promise((resolve, reject) => {
               $.ajax({
                   type: 'GET',
                   url: "{% url 'deleteallbacktest' %}",
                   dataType : "json",
                   data: '',
                   beforeSend: function(){
                        $('#loader').show();
                    },
                   success: function(data) {
                       resolve(data)
                   },
                   complete:function(data){
                        $('#loader').hide();
                    },
                   error: function(error) {
                       reject(error)
                   },
               })
           })
       }

       $(document).on("click","#deletebacktest",function() {
            resetCounter()
            let selectedOption = $('#selectedBacktestJob option:selected');
            if(selectedOption.val() === '') return
            Swal.fire({
                title: 'Delete Job?',
                text: "Confirm to delete job " + selectedOption.text(),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
                }).then((result) => {
                if (result.isConfirmed) {
                    deleteBacktest(selectedOption.val()).then(data => {
                        Swal.fire({
                            //position: 'top-end',
                            icon: 'success',
                            title: 'Job has been deleted',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(function (result) {
                            renderBacktestJobLists(data.backtestjobs)
                        })
                    }).catch(error => {})
                }
            })

        })

        function deleteBacktest(id){   
           return new Promise((resolve, reject) => {
                data = {
                    id: id,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
               $.ajax({
                   type: 'POST',
                   url: "{% url 'deletebacktest' %}",
                   dataType : "json",
                   data: data,
                   beforeSend: function(){
                        $('#loader').show();
                    },
                   success: function(data) {
                       resolve(data)
                   },
                   complete:function(data){
                        $('#loader').hide();
                    },
                   error: function(error) {
                       reject(error)
                   },
               })
           })
       }
       
       $(document).on("click","#jogtest",function() {
            $('#report_table').html('');
            let selectedOption = $('#selectedBacktestJob option:selected');
            if(selectedOption.val() === '') {
                Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'please select Job!',
                    })
                return
            }
            if(_rawData.length === 0) return 
            if(count == _rawData.length  - testRange +1 ){
                Swal.fire({
                    icon: 'info',
                    title: 'Finished',
                    text: 'Back testing is finished!',
                })

                let html ='';
                if(testResult.length > 0){
                    testResult.forEach((result,key )=> {
                        html += `<tr>
                            <td>${key+1}</td>
                            <td>${result.entry}</td>
                            <td>${result.exit}</td>
                            </tr>`;
                    });
                }
                $('#report_table').html(html)
                showFinish();
                return
            }
            let _count = count++;
            let arraySet = _rawData.slice(_count,_count + testRange)
            createData(arraySet);
        })



        $(document).on("click","#autotest",function() {
            $('#report_table').html('');
            let selectedOption = $('#selectedBacktestJob option:selected');
            if(selectedOption.val() === '') {
                Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'please select Job!',
                    })
                
                // resetCounter();
                return
            }

            if(_rawData.length === 0) return 

            if (this.classList.contains('start')) {
                this.classList.remove('start');
                this.textContent = "Auto Test";
                clearInterval(backtestTimer);
            } else {
                this.classList.add('start');
                this.textContent = "Stop";
                autoTest();
            }
        })

        function autoTest(){
            function testing(){
                if(count == _rawData.length  - testRange +1 ){
                    clearInterval(backtestTimer);
                    $('#autotest').removeClass('start');
                    $('#autotest').text("Auto Test") ;
                    // resetCounter();
                    Swal.fire({
                        icon: 'info',
                        title: 'Finished',
                        text: 'Back testing is finished!',
                    })
                    // console.log(testResult);
                   
                    let html ='';
                    if(testResult.length > 0){
                        testResult.forEach((result,key )=> {
                            html += `<tr>
                                <td>${key+1}</td>
                                <td>${result.entry}</td>
                                <td>${result.exit}</td>
                                </tr>`;
                        });
                    }
                    $('#report_table').html(html)
                    showFinish();
                    return
                }
                let _count = count++;
                let arraySet = _rawData.slice(_count,_count + testRange)
                createData(arraySet);
            }
            backtestTimer = setInterval(testing,backtestTimerInterval);
            var c = 0;
        }

        function showFinish(){
            let firstIndex = _rawData[0].index;
            testResult.forEach((result,key )=> {
                let entryindex = result.entry - firstIndex;
                let entryvalue = _rawData[entryindex]
                let exitindex = result.exit - firstIndex;
                let exitvalue = _rawData[exitindex]
                MarkData.push({
                    name: result.type,
                    value: entryvalue.close,
                    xAxis: entryindex,
                    yAxis: entryvalue.close,
                    color: "#fff",
                });
                // MarkData.push({
                //     name: "Exit",
                //     value: exitvalue.close,
                //     xAxis: exitindex,
                //     yAxis: exitvalue.close,
                //     color: "#fff",
                // });
            })

            createData(_rawData);
            // console.log(_rawData)
            canndleStickChart.dispatchAction({
                type: 'dataZoom',
                start: 0,
                end: 100
            });
        }


        function resetCounter(){
            count = 0;
            _rawData = [];
        }

        $(document).on("change","#selectedBacktestJob",function() {
            MarkData = [];
            orderBuyEntryPointflag = false;
            orderSellEntryPointflag = false;
            testResult = [];
            tmpDataIn = null;
            countResult = 0;
            resetCounter()
            let selectedOption = $('#selectedBacktestJob option:selected');
            if(selectedOption.val() === '') return
            let html_symbol = ``
            let html_timeframe = ``
            let html_backtestsize = ``
            let html_interval = ``
            let html_openbuy_testspecs = ``
            let html_opensell_testspecs = ``

            getBacktestJob(selectedOption.val(),$(this).find(':selected').data('id')).then(data => {
                let backtest = JSON.parse(data.backtest)[0].fields;
                let _orderbuy_entry_specs = JSON.parse(data.entryspecs).filter(x => x.fields.order_type == 0);
                let _ordersell_entry_specs = JSON.parse(data.entryspecs).filter(x => x.fields.order_type == 1);

                let _orderbuy_close_specs = JSON.parse(data.exitspecs).filter(x => x.fields.order_type == 0);
                let _ordersell_close_specs = JSON.parse(data.exitspecs).filter(x => x.fields.order_type == 1);

                orderbuy_close_specs = _orderbuy_close_specs;
                ordersell_close_specs = _ordersell_close_specs;

                orderbuy_entry_specs = _orderbuy_entry_specs;
                ordersell_entry_specs = _ordersell_entry_specs;
                console.log(_ordersell_close_specs)

                if(JSON.parse(data.entryspecs).length == 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: `Not found Test spec for ${$(this).find(':selected').data('name')}`,
                    })
                }
                _rawData =  createRawData(data.ohlcs);

                _orderbuy_entry_specs.forEach(spec_item => {
                    html_openbuy_testspecs += `<tr>
                        <td>${ spec_item.fields.name}</td>
                        <td id="td_orderbuy_spec_${spec_item.fields.parameter}">${spec_item.fields.entry_value}</td>
                        <td id="td_orderbuy_reading_${spec_item.fields.parameter}"></td>
                        </tr>`;
                });

                _ordersell_entry_specs.forEach(spec_item => {
                    html_opensell_testspecs += `<tr>
                        <td>${ spec_item.fields.name}</td>
                        <td id="td_ordersell_spec_${spec_item.fields.parameter}">${spec_item.fields.entry_value}</td>
                        <td id="td_ordersell_reading_${spec_item.fields.parameter}"></td>
                        </tr>`;
                });

                JSON.parse(data.symbols).forEach(symbol_item => {
                    let _selectText = '';
                    if(symbol_item.pk == backtest.symbol) {_selectText = 'selected'}
                    html_symbol += `<option value="${symbol_item.pk}" ${_selectText}>${symbol_item.fields.name}</option>`
                });

                JSON.parse(data.timeframes).forEach(timeframe_item => {
                    let _selectText = '';
                    if(timeframe_item.pk == backtest.timeframe) 
                    {
                        _selectText = 'selected'
                    }
                    if(timeframe_item.pk == backtest.timeframe) _selectText = 'selected'
                    html_timeframe += `<option value="${timeframe_item.pk}" ${_selectText}>${timeframe_item.fields.name}</option>`
                });

                JSON.parse(data.backtestsizes).forEach(backtestsize_item => {
                    let _selectText = '';
                    if(backtestsize_item.pk == backtest.backtestsize) _selectText = 'selected'
                    html_backtestsize += `<option value="${backtestsize_item.pk}" ${_selectText}>${backtestsize_item.fields.size}</option>`
                });

                JSON.parse(data.intervals).forEach(interval_item => {
                    let _selectText = '';
                    if(interval_item.pk == backtest.interval) _selectText = 'selected'
                    html_interval += `<option value="${interval_item.pk}" ${_selectText}>${interval_item.fields.interval}</option>`
                });
                
                $('#symbolname').html(`(${$(this).find(':selected').data('name')})`);
                $('#symbols').html(html_symbol);
                $('#backtesttimeframe').html(html_timeframe);
                $('#backtestSize').html(html_backtestsize);
                $('#interval').html(html_interval);
                $('#orderbuy_spec_table').html(html_openbuy_testspecs);
                $('#ordersell_spec_table').html(html_opensell_testspecs);
                $("#timeframe").html($('#backtesttimeframe option:selected').text());
                $("#symbol").html($('#symbols option:selected').text());
                backtestTimerInterval = parseInt($('#interval option:selected').text());
            }).catch(error => {})
        })

        function getBacktestJob(id,symbol_id){
            return new Promise((resolve, reject) => {
                data = {
                    id: id,
                    symbol_id : symbol_id,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
                $.ajax({
                    type: 'POST',
                    url: "{% url 'getbacktestjob' %}",
                    dataType : "json",
                    data: data,
                    success: function(data) {
                        resolve(data)
                    },
                    error: function(error) {
                        reject(error)
                    },
                })
            })
        }


       function saveFirstFoundStatus(status){
            return new Promise((resolve, reject) => {
                data = {
                    status : status,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                }
                $.ajax({
                    type: 'POST',
                    url: "{% url 'savefirstfoundstatus' %}",
                    dataType : "json",
                    data: data,
                    success: function(data) {
                        resolve(data)
                    },
                    error: function(error) {
                        reject(error)
                    },
                })
            })
        }
    </script>

{% endblock %} 
